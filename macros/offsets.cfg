# -----------------------------------------------------------------------------
# Hybrid tool-offset calibration settings
# - XY from Nudge via tools_calibrate
# - Z from Beacon contact probing
# -----------------------------------------------------------------------------
[gcode_macro _TC_CAL_SETTINGS]
description: Settings for hybrid tool offset calibration
variable_probe_temp: 150
variable_contact_probe_x: 175.0
variable_contact_probe_y: 165.0
variable_contact_probe_z_hop: 10.0
variable_contact_probe_samples: 3
variable_contact_probe_tolerance: 0.008
variable_contact_probe_retract: 2.0
gcode:

[gcode_macro TC_SET_CONTACT_PROBE_POSITION]
description: Set beacon contact XY position for offset calibration
gcode:
  {% if params.X is defined %}
    SET_GCODE_VARIABLE MACRO=_TC_CAL_SETTINGS VARIABLE=contact_probe_x VALUE={params.X|float}
  {% endif %}
  {% if params.Y is defined %}
    SET_GCODE_VARIABLE MACRO=_TC_CAL_SETTINGS VARIABLE=contact_probe_y VALUE={params.Y|float}
  {% endif %}
  RESPOND MSG="Contact probe XY set to X{printer['gcode_macro _TC_CAL_SETTINGS'].contact_probe_x|float|round(3)} Y{printer['gcode_macro _TC_CAL_SETTINGS'].contact_probe_y|float|round(3)}"

[gcode_macro TC_GET_PROBE_POSITION]
description: Locate nudge sensor coordinates and save to disk
gcode:
  TOOL_LOCATE_SENSOR
  _TC_SAVE_PROBE_POSITION

[gcode_macro _NUDGE_FIND_TOOL_BASELINE]
description: Find baseline tool location over nudge sensor
gcode:
  _NUDGE_MOVE_OVER_PROBE
  TOOL_LOCATE_SENSOR

[gcode_macro _NUDGE_MOVE_OVER_PROBE]
description: Move toolhead to saved nudge probe position
gcode:
  {% set svf = printer.save_variables.variables %}
  {% set feed = printer['configfile'].config['tools_calibrate']['travel_speed']|int * 60 %}
  {% set px = svf.get('nudge_position_x', -1000)|float %}
  {% set py = svf.get('nudge_position_y', 0)|float %}
  {% set pz = svf.get('nudge_position_z', 10)|float %}
  {% if px <= -999 %}
    RESPOND TYPE=error MSG="Nudge probe position not set. Put T0 over sensor and run TC_GET_PROBE_POSITION first."
  {% else %}
    G0 X{px} Y{py} Z{pz} F{feed}
  {% endif %}

[gcode_macro _TC_SAVE_PROBE_POSITION]
description: Persist nudge probe position from last locate run
gcode:
  SAVE_VARIABLE VARIABLE=nudge_position_x VALUE={printer.tools_calibrate.last_x_result|float|round(3)}
  SAVE_VARIABLE VARIABLE=nudge_position_y VALUE={printer.tools_calibrate.last_y_result|float|round(3)}
  SAVE_VARIABLE VARIABLE=nudge_position_z VALUE={printer.tools_calibrate.last_z_result|float|round(3) + 3}
  RESPOND MSG="Saved nudge position X={printer.tools_calibrate.last_x_result|float|round(3)} Y={printer.tools_calibrate.last_y_result|float|round(3)} Z={printer.tools_calibrate.last_z_result|float|round(3) + 3.0}"

[gcode_macro TC_FIND_ALL_TOOL_OFFSETS]
description: Calibrate offsets for all non-T0 tools
gcode:
  {% set ns = namespace(csv='') %}
  {% for t in printer.toolchanger.tool_numbers if t|int != 0 %}
    {% set ns.csv = ns.csv ~ (',' if ns.csv else '') ~ (t|string) %}
  {% endfor %}
  {% if ns.csv == '' %}
    RESPOND MSG="No non-T0 tools found."
  {% else %}
    TC_FIND_TOOL_OFFSETS TOOL={ns.csv}
  {% endif %}

[gcode_macro TC_FIND_TOOL_OFFSETS]
description: Calibrate offsets for specified tools. Usage TC_FIND_TOOL_OFFSETS TOOL=1,2,5
variable_t0_contact_z: 0.0
variable_tool_contact_z: 0.0
gcode:
  {% set settings = printer['gcode_macro _TC_CAL_SETTINGS'] %}
  {% set tools = params.TOOL|default('1')|string %}

  {% if "xyz" not in printer.toolhead.homed_axes %}
    RESPOND TYPE=error MSG="Printer must be homed before offset calibration."
  {% else %}
    SET_GCODE_OFFSET X=0 Y=0 Z=0 MOVE=0

    _TC_PREP_TOOL_FOR_PROBING TOOL=0
    _NUDGE_FIND_TOOL_BASELINE
    _TC_CONTACT_PROBE_CAPTURE TOOL=0 VAR=t0_contact_z

    {% for raw_t in tools.split(',') %}
      {% set t = raw_t|int %}
      {% if t == 0 %}
        RESPOND MSG="Skipping TOOL=0 in requested list."
      {% else %}
        _TC_PREP_TOOL_FOR_PROBING TOOL={t}
        _NUDGE_MOVE_OVER_PROBE
        TOOL_CALIBRATE_TOOL_OFFSET
        _TC_SAVE_XY_TO_TOOL TOOL={t}
        _TC_CONTACT_PROBE_CAPTURE TOOL={t} VAR=tool_contact_z
        _TC_SAVE_Z_DELTA_TO_TOOL TOOL={t}
        RESPOND MSG="Finished T{t}."
      {% endif %}
    {% endfor %}

    T0
    {% if printer.idle_timeout.state != "Printing" %}
      M104 S0 T0
    {% endif %}
    RESPOND MSG="TC_FIND_TOOL_OFFSETS complete."
  {% endif %}

[gcode_macro _TC_PREP_TOOL_FOR_PROBING]
# -----------------------------------------------------------------------------
# Hybrid calibration internals
# -----------------------------------------------------------------------------
gcode:
  {% set t = params.TOOL|int %}
  {% set settings = printer['gcode_macro _TC_CAL_SETTINGS'] %}
  T{t}
  GO_TO_PURGE
  M109 S{settings.probe_temp} T{t} D0
  CLEAN_NOZZLE

[gcode_macro _TC_MOVE_TO_CONTACT_POINT]
gcode:
  {% set settings = printer['gcode_macro _TC_CAL_SETTINGS'] %}
  G90
  G0 Z{settings.contact_probe_z_hop|float} F1200
  G0 X{settings.contact_probe_x|float} Y{settings.contact_probe_y|float} F12000

[gcode_macro _TC_CONTACT_PROBE_CAPTURE]
description: Run contact probe and stage beacon last_z_result into macro variable
gcode:
  {% set settings = printer['gcode_macro _TC_CAL_SETTINGS'] %}
  _TC_MOVE_TO_CONTACT_POINT
  PROBE PROBE_METHOD=contact SAMPLES={settings.contact_probe_samples|int} SAMPLES_TOLERANCE={settings.contact_probe_tolerance|float} SAMPLE_RETRACT_DIST={settings.contact_probe_retract|float}
  _TC_CAPTURE_BEACON_LAST_Z VAR={params.VAR|string}

[gcode_macro _TC_CAPTURE_BEACON_LAST_Z]
gcode:
  {% set v = params.VAR|string %}
  SET_GCODE_VARIABLE MACRO=TC_FIND_TOOL_OFFSETS VARIABLE={v} VALUE={printer.beacon.last_z_result|float}
  RESPOND MSG="{v}={printer.beacon.last_z_result|float|round(4)}"

[gcode_macro _TC_SAVE_XY_TO_TOOL]
gcode:
  {% set t = params.TOOL|int %}
  SET_TOOL_PARAMETER T={t} PARAMETER=gcode_x_offset VALUE="{printer.tools_calibrate.last_x_result|float|round(3)}"
  SAVE_TOOL_PARAMETER T={t} PARAMETER=gcode_x_offset
  SET_TOOL_PARAMETER T={t} PARAMETER=gcode_y_offset VALUE="{printer.tools_calibrate.last_y_result|float|round(3)}"
  SAVE_TOOL_PARAMETER T={t} PARAMETER=gcode_y_offset
  RESPOND MSG="Saved T{t} XY: X={printer.tools_calibrate.last_x_result|float|round(3)} Y={printer.tools_calibrate.last_y_result|float|round(3)}"

[gcode_macro _TC_SAVE_Z_DELTA_TO_TOOL]
gcode:
  {% set t = params.TOOL|int %}
  {% set m = printer['gcode_macro TC_FIND_TOOL_OFFSETS'] %}
  {% set z_delta = (m.tool_contact_z|float - m.t0_contact_z|float)|round(4) %}
  SET_TOOL_PARAMETER T={t} PARAMETER=gcode_z_offset VALUE="{z_delta}"
  SAVE_TOOL_PARAMETER T={t} PARAMETER=gcode_z_offset
  RESPOND MSG="Saved T{t} Z: Z={z_delta} (tool - T0)"
