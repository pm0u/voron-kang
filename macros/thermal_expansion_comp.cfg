[gcode_macro BEACON_VARS]
variable_beacon_contact_calibration_temp: 150
variable_beacon_contact_expansion_compensation: True
variable_beacon_contact_expansion_multiplier: 0.8
gcode:

[delayed_gcode _BEACON_INIT]
initial_duration: 0.1
gcode:
  _BEACON_SET_NOZZLE_TEMP_OFFSET RESET=True

[gcode_macro _BEACON_SET_NOZZLE_TEMP_OFFSET]
gcode:
  {% set reset = params.RESET|default(False)|string|lower in ['1', 'true', 'yes', 'on'] %}
  {% set z_speed = printer.configfile.settings['stepper_z'].homing_speed|float * 60 %}
  {% set calibration_temp = printer['gcode_macro BEACON_VARS'].beacon_contact_calibration_temp|default(150)|float %}
  {% set enabled = printer['gcode_macro BEACON_VARS'].beacon_contact_expansion_compensation|default(True)|string|lower in ['1', 'true', 'yes', 'on'] %}
  {% set multiplier = printer['gcode_macro BEACON_VARS'].beacon_contact_expansion_multiplier|default(1.0)|float %}
  {% set svv = printer.save_variables.variables %}

  {% if reset %}
    SAVE_VARIABLE VARIABLE=nozzle_expansion_applied_offset VALUE=0
  {% elif enabled %}
    {% set coeff = svv.nozzle_expansion_coefficient|default(0)|float %}
    {% set applied = svv.nozzle_expansion_applied_offset|default(0)|float %}
    {% set temp = printer.extruder.target|float %}
    {% set temp_offset = temp - calibration_temp %}
    {% set expansion_offset = multiplier * (temp_offset * (coeff / 100)) %}
    {% set new_offset = (-applied) + expansion_offset %}
    SET_GCODE_OFFSET Z_ADJUST={new_offset} MOVE=1 SPEED={z_speed}
    SAVE_VARIABLE VARIABLE=nozzle_expansion_applied_offset VALUE={expansion_offset}
    RESPOND MSG={'"Nozzle expansion offset of %.6fmm applied"' % (expansion_offset)}
  {% endif %}

[gcode_macro _BEACON_REMOVE_NOZZLE_TEMP_OFFSET]
gcode:
  {% set enabled = printer['gcode_macro BEACON_VARS'].beacon_contact_expansion_compensation|default(True)|string|lower in ['1', 'true', 'yes', 'on'] %}
  {% if enabled %}
    {% set z_speed = printer.configfile.settings['stepper_z'].homing_speed|float * 60 %}
    {% set svv = printer.save_variables.variables %}
    {% set applied = svv.nozzle_expansion_applied_offset|default(0)|float %}
    SET_GCODE_OFFSET Z_ADJUST={-applied} MOVE=0 SPEED={z_speed}
  {% endif %}

[gcode_macro BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET]
variable_reference_z: 0.0
gcode:
  {% if printer.toolhead.homed_axes != 'xyz' %}
    G28
  {% endif %}
  G90
  G0 X175 Y175 Z10 F12000
  _BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=150
  _BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=150
  _BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=250
  _BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=250
  _BEACON_NOZZLE_TEMP_OFFSET

[gcode_macro _BEACON_PROBE_NOZZLE_TEMP_OFFSET]
gcode:
  {% set temp = params.TEMP|int %}
  {% set z_speed = printer.configfile.settings['stepper_z'].homing_speed|float * 60 %}
  RESPOND MSG="Waiting for nozzle to reach {temp}C..."
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp} MAXIMUM={temp + 2}
  RESPOND MSG="Waiting 60s for thermal expansion..."
  G4 P60000
  RESPOND MSG="Probing with nozzle temperature {temp}C..."
  PROBE PROBE_METHOD=contact SAMPLES=5 SAMPLES_TOLERANCE=0.005 SAMPLES_TOLERANCE_RETRIES=10 SAMPLES_RESULT=median
  G0 Z5 F{z_speed}

[gcode_macro _BEACON_STORE_NOZZLE_TEMP_OFFSET]
gcode:
  {% set temp = params.TEMP|int %}
  {% set svv = printer.save_variables.variables %}
  {% set last_z = printer.beacon.last_z_result|default(0)|float %}
  {% if temp == 150 %}
    SET_GCODE_VARIABLE MACRO=BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET VARIABLE=reference_z VALUE={last_z}
  {% else %}
    {% set reference_z = printer['gcode_macro BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET'].reference_z|default(0)|float %}
    SAVE_VARIABLE VARIABLE=nozzle_expansion_coefficient VALUE={(last_z - reference_z)}
  {% endif %}

[gcode_macro _BEACON_NOZZLE_TEMP_OFFSET]
gcode:
  {% set svv = printer.save_variables.variables %}
  RESPOND MSG={'"Expansion coefficient %.6f"' % (svv.nozzle_expansion_coefficient|default(0)|float)}
