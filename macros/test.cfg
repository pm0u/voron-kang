[gcode_macro TC_CONTACT_BASELINE]
description: Capture baseline contact Z at test point
variable_base_z: 0.0
gcode:
  G28 X Y
  G28 Z METHOD=proximity
  T0
  M109 S150
  CLEAN_NOZZLE
  G90
  G0 X175 Y175 Z10 F12000
  PROBE PROBE_METHOD=contact
  SET_GCODE_VARIABLE MACRO=TC_CONTACT_BASELINE VARIABLE=base_z VALUE={printer.probe.last_z_result|float}
  RESPOND MSG="Baseline Z={printer.probe.last_z_result|float|round(4)}"
  RESPOND MSG="Now place shim and run: TC_CONTACT_WITH_SHIM THICKNESS=<mm>"

[gcode_macro TC_CONTACT_WITH_SHIM]
description: Re-probe with shim, compare to baseline (no writes)
gcode:
  {% set t = params.THICKNESS|float %}
  {% set b = printer["gcode_macro TC_CONTACT_BASELINE"].base_z|float %}
  T0
  M109 S150
  CLEAN_NOZZLE
  G90
  G0 X175 Y175 Z10 F12000
  PROBE PROBE_METHOD=contact
  {% set z = printer.probe.last_z_result|float %}
  {% set delta = (z - b)|round(4) %}
  {% set err = (delta - t)|round(4) %}
  RESPOND MSG="Baseline={b|round(4)} Shim={z|round(4)} Delta={delta}"
  RESPOND MSG="Expected~{t|round(4)} Error={err}"
  RESPOND MSG="Sandbox only: nothing saved"