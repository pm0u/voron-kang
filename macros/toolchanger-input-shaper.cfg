[gcode_macro AXES_SHAPER_CALIBRATION]
rename_existing: _AXES_SHAPER_CALIBRATION_BASE
gcode:
  {%- import homing as h with context -%}
  {%- import message as msg -%}

  {% set tool_to_change_to = params.T | default("") %}

  {% if tool_to_change_to != "" %}
    {msg.echo("Changing to tool T"+tool_to_change_to)}
    {h.orient()}
    SELECT_TOOL T={tool_to_change_to} RESTORE_AXIS=xyz
    {% set filtered_params = rawparams | lower | replace("t="+tool_to_change_to, "") %}
      {% set message = 'Performing input shaping with chip adxl345 t'+tool_to_change_to %}
      {% if filtered_params != "" %}
        {% set message = message + " and" + filtered_params %}
      {% endif %}
    {msg.echo("{message}")}
    _AXES_SHAPER_CALIBRATION_BASE accel_chip='"adxl345 t{tool_to_change_to}"' {filtered_params}
  {% else %}
    {% set ns = namespace(tn=printer.toolchanger.tool_number|int) %}
    RESPOND type=echo MSG="Using current tool..."
    {% if ns.tn != -1 %}
      RESPOND type=echo MSG="Current tool is: {ns.tn}"
      {h.orient()}
      RESPOND type=echo MSG="Performing input shaping with chip adxl345 t{ns.tn}"
      _AXES_SHAPER_CALIBRATION_BASE ACCEL_CHIP='"adxl345 t{ns.tn}"' {rawparams}
    {% else %}
      { action_raise_error("No active tool in toolchanger state. Select a tool first (e.g. T0) or run AXES_SHAPER_CALIBRATION T=<tool>." ) }
    {% endif %}
  {% endif %}

[gcode_macro COMPARE_BELTS_RESPONSES]
rename_existing: _COMPARE_BELTS_RESPONSES_BASE
gcode:
  {%- import homing as h with context -%}
  {%- import message as msg -%}

  {% set tool_to_change_to = params.T | default("") %}

  {% if tool_to_change_to != "" %}
    {msg.echo("Changing to tool T"+tool_to_change_to)}
    {h.orient()}
    SELECT_TOOL T={tool_to_change_to} RESTORE_AXIS=xyz
    {% set filtered_params = rawparams | lower | replace("t="+tool_to_change_to, "") %}
      {% set message = 'Performing belt comparison with chip adxl345 t'+tool_to_change_to %}
      {% if filtered_params != "" %}
        {% set message = message + " and" + filtered_params %}
      {% endif %}
    {msg.echo("{message}")}
    _COMPARE_BELTS_RESPONSES_BASE accel_chip='"adxl345 t{tool_to_change_to}"' {filtered_params}
  {% else %}
    {% set ns = namespace(tn=printer.toolchanger.tool_number|int) %}
    RESPOND type=echo MSG="Using current tool..."
    {% if ns.tn != -1 %}
      RESPOND type=echo MSG="Current tool is: {ns.tn}"
      {h.orient()}
      RESPOND type=echo MSG="Performing belt comparison with chip adxl345 t{ns.tn}"
      _COMPARE_BELTS_RESPONSES_BASE ACCEL_CHIP='"adxl345 t{ns.tn}"' {rawparams}
    {% else %}
      { action_raise_error("No active tool in toolchanger state. Select a tool first (e.g. T0) or run COMPARE_BELTS_RESPONSES T=<tool>." ) }
    {% endif %}
  {% endif %}
