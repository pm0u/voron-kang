[gcode_macro AXES_SHAPER_CALIBRATION]
rename_existing: _AXES_SHAPER_CALIBRATION_BASE
gcode:
  {%- import homing as h with context -%}
  {%- import message as msg -%}

  {% set tool_to_change_to = params.T | default("") %}

  {% if tool_to_change_to != "" %}
    {msg.echo("Changing to tool T"+tool_to_change_to)}
    {h.orient()}
    SELECT_TOOL T={tool_to_change_to} RESTORE_AXIS=xyz
    {% set filtered_params = rawparams | lower | replace("t="+tool_to_change_to, "") %}
      {% set message = 'Performing input shaping with chip adxl345 t'+tool_to_change_to %}
      {% if filtered_params != "" %}
        {% set message = message + " and" + filtered_params %}
      {% endif %}
    {msg.echo("{message}")}
    _AXES_SHAPER_CALIBRATION_BASE accel_chip='"adxl345 t{tool_to_change_to}"' {filtered_params}
  {% else %}
    RESPOND type=echo MSG="Using current tool..."
    {% set current_tool = printer.toolchanger.tool_number %}
    {% if current_tool != -1 %}
      RESPOND type=echo MSG="Current tool is: {current_tool}"
      {h.orient()}
      RESPOND type=echo MSG="Performing input shaping with chip adxl345 t{current_tool}"
      _AXES_SHAPER_CALIBRATION_BASE ACCEL_CHIP='"adxl345 t{current_tool}"' {rawparams}
    {% else %}
      RESPOND type=echo MSG="No tool detected. Attempting to initialize..."
      _INITIALIZE_FROM_DETECTED_TOOL
      VERIFY_TOOL_DETECTED
      RESPOND type=echo MSG="Initialize with: {printer.printer.toolchanger.tool_number}"
      _AXES_SHAPER_CALIBRATION_BASE ACCEL_CHIP='"adxl345 t{printer.printer.toolchanger.tool_number}"' {rawparams}
    {% endif %}
  {% endif %}
