[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {%- import led as led with context -%}
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    {led.heating(params.T)}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    {led.heating()}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>] [D<deadband>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature.
  D= Dead-band, allows the temperature variance +/- the deadband.
gcode:
  {%- import led as led with context -%}
  {%- set tool = params.T | default(printer.tool.tool_number)%}
  {% set newparameters = "" %}
  {% set newparameters = newparameters ~ " T="~tool %}
  {% if params.S is defined %}
    {% set newparameters = newparameters ~ " TARGET="~params.S %}
  {% endif %}
  {% set delta = (params.D | default(4) | int) / 2 %}
  {led.heating(tool)}
  {% if delta > 0 %}
    {% set extruder_num = 'extruder' ~ (tool if tool != 0 else '')%}
    {action_respond_info('Waiting for temp on tool ' ~ tool ~ '@' ~ params.S '+/-' ~ delta)}
    SET_TOOL_TEMPERATURE WAIT=0 {newparameters}
    TEMPERATURE_WAIT SENSOR=extruder{params.T} MINIMUM={params.S|int - delta} MAXIMUM={params.S|int + delta}
  {% else %}
    SET_TOOL_TEMPERATURE WAIT=1 {newparameters}
  {% endif %}